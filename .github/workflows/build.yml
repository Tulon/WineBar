name: Build

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: Version name (x.y.z)
      arch:
        required: true
        type: string
        description: Architecture (x64|arm)
      runs-on:
        required: true
        type: string
        description: Github runner name

  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
        description: Version name (x.y.z)
      arch:
        required: true
        type: choice
        description: Architecture
        options: 
          - x64
          - arm64
      runs-on:
        required: true
        type: choice
        description: Github runner name
        options:
          - ubuntu-24.04
          - ubuntu-24.04-arm

jobs:
  build-x64:
    name: Build
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 20

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install mingw-w64-i686-dev g++-mingw-w64-i686 binutils-mingw-w64-i686 \
            libgtk-3-dev libglu1-mesa curl git unzip xz-utils zip ninja-build desktop-file-utils

      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: main  # Has to be main for linux-arm64 to work.
          flutter-version: 3.38.2

      - name: Clone repository
        uses: actions/checkout@v5

      - name: Build AppImage
        run: |
          ./packaging/scripts/build_appimage.sh ${{ inputs.arch }} ${{ inputs.version }}

      - name: Upload build artefacts
        uses: actions/upload-artifact@v4
        with:
          name: "WineBar-${{ inputs.version }}-${{ inputs.arch }}.AppImage"
          path: "build/linux/${{ inputs.arch }}/release/WineBar-${{ inputs.version }}-${{ inputs.arch }}.AppImage"
          if-no-files-found: error
